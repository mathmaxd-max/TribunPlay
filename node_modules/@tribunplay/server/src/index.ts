import { fromHono } from "chanfana";
import { Hono } from "hono";
import { GameCreate } from "./endpoints/gameCreate";
import { GameJoin } from "./endpoints/gameJoin";
import { GameGet } from "./endpoints/gameGet";
import { GameRoom } from "./durable-objects/GameRoom";

// Start a Hono app
const app = new Hono<{ Bindings: Env }>();

// Setup OpenAPI registry
const openapi = fromHono(app, {
	docs_url: "/",
});

// Register game API endpoints
openapi.post("/api/game/create", GameCreate);
openapi.post("/api/game/join", GameJoin);
openapi.get("/api/game/:code", GameGet);

// WebSocket endpoint for game rooms
app.get("/ws/game/:gameId", async (c) => {
	const gameId = c.req.param("gameId");
	const token = new URL(c.req.url).searchParams.get("token");
	
	if (!token) {
		return new Response("Missing token", { status: 401 });
	}
	
	// Create DO instance keyed by gameId
	const doId = c.env.GAME_ROOM.idFromName(gameId);
	const stub = c.env.GAME_ROOM.get(doId);
	
	// Pass gameId in headers so DO can access it
	const request = new Request(c.req.raw);
	request.headers.set("X-Game-Id", gameId);
	
	return stub.fetch(request);
});

// Export the Hono app
export default app;

// Export Durable Object class
export { GameRoom };
